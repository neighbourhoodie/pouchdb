import { clone } from 'pouchdb-utils';

function removeLeafFromRevTree(tree, leafRev) {
  const _tree = clone(tree);
  const toVisit = _tree.slice();

  let previousNode;
  let node;
  while ((node = toVisit.pop())) {
    const pos = node.pos;
    const [id, opts, branches] = node.ids;
    const isLeaf = branches.length === 0;
    const hash = `${pos}-${id}`;

    if (isLeaf && hash === leafRev && opts.status === "available") {
      previousNode.ids[2] = previousNode.ids[2].filter(function (branchNode) {
        return branchNode[0] !== id;
      });
      return _tree;
    }
    previousNode = node;

    if (branches.length) {
      for (let i = 0, len = branches.length; i < len; i++) {
        toVisit.push({pos: pos + 1, ids: branches[i]});
      }
    }
  }
  return _tree;
}

export default removeLeafFromRevTree;
